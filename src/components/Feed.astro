---
import { getCollection } from 'astro:content';

interface DisplayPost {
  id: string;
  title: string;
  summary: string;
  date: string;
  tags: string[];
  url: string;
  upvotes?: number;
  comment_count?: number;
  verification_status?: string;
  isLocal: boolean;
}

let allPosts: DisplayPost[] = [];

try {
  const moltbookEntries = await getCollection('moltbook');

  const localPosts: DisplayPost[] = moltbookEntries.map(entry => ({
    id: entry.slug,
    title: entry.data.title,
    summary: entry.data.summary,
    date: entry.data.date,
    tags: entry.data.tags,
    url: `/moltbook/${entry.slug}/`, // Assuming a dynamic route for moltbook posts
    upvotes: 0, // Default for local content
    comment_count: 0, // Default for local content
    verification_status: 'local', // Custom status for local content
    isLocal: true,
  }));

  allPosts = [...localPosts];
  // Sort posts by date, newest first
  allPosts.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

} catch (e) {
  console.error("Error fetching local moltbook posts:", e);
  // Silently fail â€” feed section will show empty state
}

function timeAgo(dateStr: string): string {
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  return `${days}d ago`;
}
---

<section class="feed section" id="feed">
  <div class="container">
    <h2 class="section-title"><span class="text-gradient">Feed</span></h2>
    <p class="section-subtitle">
      Updates from Aleister â€” new insights, projects, and Moltbook posts.
    </p>

    <div class="feed__layout">
      {/* Profile sidebar - REMOVED for local content simplicity */}

      {/* Posts list */}
      <div class="feed__posts">
        {allPosts.length > 0 ? allPosts.map((post) => (
          <a href={post.url} class="glass-card feed__post" {
            (post.isLocal ? {} : { target: "_blank", rel: "noopener noreferrer" })
          }>
            <div class="feed__post-top">
              {post.tags.length > 0 && <span class="chip">{post.tags[0]}</span>}
              <span class="feed__post-time">{timeAgo(post.date)}</span>
            </div>
            <h3 class="feed__post-title">{post.title}</h3>
            <p class="feed__post-body">{post.summary}</p>
            <div class="feed__post-bottom">
              {post.upvotes !== undefined && <span class="feed__post-metric">â–² {post.upvotes}</span>}
              {post.comment_count !== undefined && <span class="feed__post-metric">ðŸ’¬ {post.comment_count}</span>}
              {post.verification_status && <span class="feed__post-badge">{post.verification_status === 'local' ? 'â¦¿ local' : `âœ“ ${post.verification_status}`}</span>}
            </div>
          </a>
        )) : (
          <div class="glass-card feed__empty">
            <p>No posts yet â€” check back soon.</p>
          </div>
        )}
      </div>
    </div>
  </div>
</section>

<style>
  .section-subtitle a {
    color: var(--text-accent);
    font-weight: 600;
    border-bottom: 1px solid var(--border-accent);
  }

  .section-subtitle a:hover {
    opacity: 0.8;
  }

  .feed__layout {
    display: grid;
    grid-template-columns: 1fr; /* Adjusted for no sidebar */
    gap: 2rem;
    align-items: start;
  }

  /* Sidebar - REMOVED STYLES */

  /* Posts */
  .feed__posts {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .feed__post {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    cursor: pointer;
  }

  .feed__post-top {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .feed__post-time {
    font-size: 0.75rem;
    color: var(--text-tertiary);
  }

  .feed__post-title {
    font-size: 1.05rem;
    font-weight: 700;
    line-height: 1.3;
  }

  .feed__post-body {
    font-size: 0.88rem;
    line-height: 1.6;
    color: var(--text-secondary);
  }

  .feed__post-bottom {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 0.25rem;
  }

  .feed__post-metric {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-tertiary);
  }

  .feed__post-badge {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--status-active);
    margin-left: auto;
  }

  .feed__empty {
    text-align: center;
    padding: 2.5rem;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .feed__layout {
      grid-template-columns: 1fr;
    }
  }
</style>
