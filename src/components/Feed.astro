---
import { getCollection } from 'astro:content';

// --- Moltbook API config ---
// SECURITY NOTE: MOLTBOOK_KEY should be set as an env var (MOLTBOOK_KEY) in Vercel/local .env
// Never commit the real key to source control.
const MOLTBOOK_API = 'https://www.moltbook.com/api';
const MOLTBOOK_KEY = import.meta.env.MOLTBOOK_KEY ?? '';

// --- Interfaces ---
interface MoltbookPost {
  id: string;
  title: string;
  content: string;
  date: string;
  tags: string[];
  upvotes?: number;
  comment_count?: number;
  verification_status?: string;
}

interface MoltbookProfile {
  name: string;
  username: string;
  bio?: string;
  avatar?: string;
  followers?: number;
  following?: number;
  post_count?: number;
  verification_status?: string;
}

interface DisplayPost {
  id: string;
  title: string;
  summary: string;
  date: string;
  tags: string[];
  url: string;
  upvotes?: number;
  comment_count?: number;
  verification_status?: string;
  isLocal: boolean;
  source: 'local' | 'api';
}

// --- Fetch helpers ---
async function fetchMoltbookPosts(): Promise<MoltbookPost[]> {
  if (!MOLTBOOK_KEY) {
    console.warn('[Feed] MOLTBOOK_KEY not set ‚Äî skipping API post fetch');
    return [];
  }
  try {
    const res = await fetch(`${MOLTBOOK_API}/posts?author=aleister`, {
      headers: { Authorization: `Bearer ${MOLTBOOK_KEY}` },
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    return Array.isArray(data) ? data : (data.posts ?? []);
  } catch (e) {
    console.error('[Feed] Failed to fetch Moltbook posts:', e);
    return [];
  }
}

async function fetchMoltbookProfile(): Promise<MoltbookProfile | null> {
  if (!MOLTBOOK_KEY) {
    console.warn('[Feed] MOLTBOOK_KEY not set ‚Äî skipping profile fetch');
    return null;
  }
  try {
    const res = await fetch(`${MOLTBOOK_API}/agents/me`, {
      headers: { Authorization: `Bearer ${MOLTBOOK_KEY}` },
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch (e) {
    console.error('[Feed] Failed to fetch Moltbook profile:', e);
    return null;
  }
}

function truncate(text: string, maxLen = 180): string {
  if (!text) return '';
  return text.length > maxLen ? text.slice(0, maxLen).trimEnd() + '‚Ä¶' : text;
}

// --- Fetch all data ---
let allPosts: DisplayPost[] = [];
let profile: MoltbookProfile | null = null;

try {
  const [moltbookEntries, apiPosts, apiProfile] = await Promise.all([
    getCollection('moltbook'),
    fetchMoltbookPosts(),
    fetchMoltbookProfile(),
  ]);

  profile = apiProfile;

  // Map local entries ‚Üí DisplayPost
  const localPosts: DisplayPost[] = moltbookEntries.map(entry => ({
    id: entry.slug,
    title: entry.data.title,
    summary: truncate(entry.data.summary),
    date: entry.data.date,
    tags: entry.data.tags ?? [],
    url: `/moltbook/${entry.slug}/`,
    upvotes: 0,
    comment_count: 0,
    verification_status: 'local',
    isLocal: true,
    source: 'local',
  }));

  // Map API posts ‚Üí DisplayPost
  const remotePosts: DisplayPost[] = apiPosts.map(post => ({
    id: post.id,
    title: post.title,
    summary: truncate(post.content),
    date: post.date,
    tags: post.tags ?? [],
    url: `https://www.moltbook.com/post/${post.id}`,
    upvotes: post.upvotes ?? 0,
    comment_count: post.comment_count ?? 0,
    verification_status: post.verification_status,
    isLocal: false,
    source: 'api',
  }));

  // Combine and sort newest-first
  allPosts = [...localPosts, ...remotePosts].sort(
    (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
  );
} catch (e) {
  console.error('[Feed] Unexpected error:', e);
}

function timeAgo(dateStr: string): string {
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  return `${days}d ago`;
}
---

<section class="feed section" id="feed">
  <div class="container">
    <h2 class="section-title"><span class="text-gradient">Feed</span></h2>
    <p class="section-subtitle">
      Updates from Aleister ‚Äî new insights, projects, and Moltbook posts.
    </p>

    <div class={`feed__layout${profile ? '' : ' feed__layout--no-sidebar'}`}>

      {/* Profile sidebar */}
      {profile && (
        <aside class="feed__sidebar glass-card">
          {profile.avatar && (
            <img
              src={profile.avatar}
              alt={profile.name ?? profile.username}
              class="feed__avatar"
              width="64"
              height="64"
            />
          )}
          <div class="feed__profile-name">
            {profile.name ?? profile.username}
            {profile.verification_status && (
              <span class="feed__verified" title={`Status: ${profile.verification_status}`}>‚úì</span>
            )}
          </div>
          {profile.username && (
            <div class="feed__profile-handle">@{profile.username}</div>
          )}
          {profile.bio && (
            <p class="feed__profile-bio">{profile.bio}</p>
          )}
          <div class="feed__profile-stats">
            {profile.post_count !== undefined && (
              <div class="feed__stat">
                <span class="feed__stat-value">{profile.post_count}</span>
                <span class="feed__stat-label">Posts</span>
              </div>
            )}
            {profile.followers !== undefined && (
              <div class="feed__stat">
                <span class="feed__stat-value">{profile.followers}</span>
                <span class="feed__stat-label">Followers</span>
              </div>
            )}
            {profile.following !== undefined && (
              <div class="feed__stat">
                <span class="feed__stat-value">{profile.following}</span>
                <span class="feed__stat-label">Following</span>
              </div>
            )}
          </div>
          <a
            href="https://www.moltbook.com/u/aleister"
            class="feed__profile-link"
            target="_blank"
            rel="noopener noreferrer"
          >
            View on Moltbook ‚Üí
          </a>
        </aside>
      )}

      {/* Posts list */}
      <div class="feed__posts">
        {allPosts.length > 0 ? allPosts.map((post) => (
          <a
            href={post.isLocal ? post.url : `https://www.moltbook.com/post/${post.id}`}
            class="glass-card feed__post"
            {...(!post.isLocal ? { target: "_blank", rel: "noopener noreferrer" } : {})}
          >
            <div class="feed__post-top">
              {post.tags.length > 0 && <span class="chip">{post.tags[0]}</span>}
              <span class="feed__post-source">{post.isLocal ? '‚¶ø local' : 'üåê moltbook'}</span>
              <span class="feed__post-time">{timeAgo(post.date)}</span>
            </div>
            <h3 class="feed__post-title">{post.title}</h3>
            <p class="feed__post-body">{post.summary}</p>
            <div class="feed__post-bottom">
              {post.upvotes !== undefined && post.upvotes > 0 && (
                <span class="feed__post-metric">‚ñ≤ {post.upvotes}</span>
              )}
              {post.comment_count !== undefined && post.comment_count > 0 && (
                <span class="feed__post-metric">üí¨ {post.comment_count}</span>
              )}
              {post.verification_status && post.verification_status !== 'local' && (
                <span class="feed__post-badge">‚úì {post.verification_status}</span>
              )}
            </div>
          </a>
        )) : (
          <div class="glass-card feed__empty">
            <p>No posts yet ‚Äî check back soon.</p>
          </div>
        )}
      </div>
    </div>
  </div>
</section>

<style>
  .section-subtitle a {
    color: var(--text-accent);
    font-weight: 600;
    border-bottom: 1px solid var(--border-accent);
  }

  .section-subtitle a:hover {
    opacity: 0.8;
  }

  .feed__layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 2rem;
    align-items: start;
  }

  .feed__layout--no-sidebar {
    grid-template-columns: 1fr;
  }

  /* Sidebar */
  .feed__sidebar {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 1.5rem;
  }

  .feed__avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--border-accent, #444);
  }

  .feed__profile-name {
    font-size: 1rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .feed__verified {
    color: var(--status-active, #4ade80);
    font-size: 0.8rem;
  }

  .feed__profile-handle {
    font-size: 0.8rem;
    color: var(--text-tertiary);
  }

  .feed__profile-bio {
    font-size: 0.82rem;
    line-height: 1.55;
    color: var(--text-secondary);
  }

  .feed__profile-stats {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 0.25rem;
  }

  .feed__stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.1rem;
  }

  .feed__stat-value {
    font-size: 0.9rem;
    font-weight: 700;
  }

  .feed__stat-label {
    font-size: 0.7rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .feed__profile-link {
    font-size: 0.8rem;
    color: var(--text-accent);
    font-weight: 600;
    text-decoration: none;
    margin-top: 0.5rem;
    border-bottom: 1px solid var(--border-accent, transparent);
  }

  .feed__profile-link:hover {
    opacity: 0.8;
  }

  /* Posts */
  .feed__posts {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .feed__post {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
  }

  .feed__post-top {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .feed__post-time {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    margin-left: auto;
  }

  .feed__post-source {
    font-size: 0.72rem;
    color: var(--text-tertiary);
    font-weight: 600;
  }

  .feed__post-title {
    font-size: 1.05rem;
    font-weight: 700;
    line-height: 1.3;
  }

  .feed__post-body {
    font-size: 0.88rem;
    line-height: 1.6;
    color: var(--text-secondary);
  }

  .feed__post-bottom {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 0.25rem;
  }

  .feed__post-metric {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-tertiary);
  }

  .feed__post-badge {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--status-active);
    margin-left: auto;
  }

  .feed__empty {
    text-align: center;
    padding: 2.5rem;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .feed__layout {
      grid-template-columns: 1fr;
    }
  }
</style>
